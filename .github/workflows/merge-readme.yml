name: Merge READMEs

# 이벤트 트리거
on:
  push:
    paths:
      - '**/README.md'  # 하위 디렉토리의 README.md 파일이 변경되었을 때 트리거
  pull_request:
    paths:
      - '**/README.md'  # PR 생성 시 트리거

jobs:
  build:
    runs-on: ubuntu-latest  # 워크플로우를 실행할 OS 환경
    
    permissions:  # GITHUB_TOKEN의 권한 명시
      contents: write  # 커밋 및 푸시를 허용

    steps:
      # 1. 코드를 체크아웃
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. Python 설정
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.9  # Python 버전 지정

      # 3. Python 스크립트 실행
      - name: Merge README files
        run: |
          import os
          import markdown
          from collections import defaultdict

          def merge_tables(directory, output_file):
              # 병합할 테이블을 저장할 딕셔너리
              combined_tables = defaultdict(list)
              
              # 모든 README.md 파일 탐색
              for subdir, dirs, files in os.walk(directory):
                  for file in files:
                      if file == "README.md":
                          file_path = os.path.join(subdir, file)
                          with open(file_path, 'r', encoding='utf-8') as f:
                              content = f.read()
                              
                              # 각 표의 제목을 기준으로 테이블 구분 (예: '📖 학습하기', '🥇 실전 훈련')
                              for line in content.splitlines():
                                  if line.startswith("## "):  # 제목이 있을 때
                                      section = line.strip().split(" ")[1]  # 제목 이름 (예: '학습하기', '실전 훈련')
                                  if line.startswith("|"):  # 테이블 데이터
                                      combined_tables[section].append(line)
              
              # 병합된 내용을 출력 파일에 작성
              with open(output_file, 'w', encoding='utf-8') as outfile:
                  # Markdown 문법으로 파일 작성
                  
                  # Write '학습하기' table
                  outfile.write("## 📖 학습하기\n\n")
                  for table in combined_tables["학습하기"]:
                      outfile.write(table + "\n\n")

                  # Write '실전 훈련' table
                  outfile.write("## 🥇 실전 훈련\n\n")
                  for table in combined_tables["실전 훈련"]:
                      outfile.write(table + "\n\n")

          # 현재 디렉토리에서 README.md 파일 병합
          merge_tables(".", "README.md")


      # 4. 변경된 파일 커밋 및 푸시
      - name: Commit changes
        run: |
          git config user.name "ddings73"
          git config user.email "ddings7303@gmail.com"
          git add README.md
          git commit -m "README 병합"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.MY_SECRET_TOKEN }}

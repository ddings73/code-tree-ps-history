name: Merge READMEs

# ì´ë²¤íŠ¸ íŠ¸ë¦¬ê±°
on:
  push:
    paths:
      - '**/README.md'  # í•˜ìœ„ ë””ë ‰í† ë¦¬ì˜ README.md íŒŒì¼ì´ ë³€ê²½ë˜ì—ˆì„ ë•Œ íŠ¸ë¦¬ê±°
  pull_request:
    paths:
      - '**/README.md'  # PR ìƒì„± ì‹œ íŠ¸ë¦¬ê±°

jobs:
  build:
    runs-on: ubuntu-latest  # ì›Œí¬í”Œë¡œìš°ë¥¼ ì‹¤í–‰í•  OS í™˜ê²½
    
    permissions:  # GITHUB_TOKENì˜ ê¶Œí•œ ëª…ì‹œ
      contents: write  # ì»¤ë°‹ ë° í‘¸ì‹œë¥¼ í—ˆìš©

    steps:
      # 1. ì½”ë“œë¥¼ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. Python ì„¤ì •
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.9  # Python ë²„ì „ ì§€ì •

      # 3. Python ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
      - name: Merge README files
        run: |
          python <<EOF
          import os
          import re

          def extract_tables(readme_content):
              """
              Extracts all markdown tables from the given README content.
              """
              tables = {
                  "í•™ìŠµí•˜ê¸°": [],
                  "ì‹¤ì „ í›ˆë ¨": []
              }

              # Regex to find markdown tables
              table_regex = r"(\|.*?\|(?:\n\|.*?-.*\|)+)"
              matches = re.findall(table_regex, readme_content, re.DOTALL)

              for match in matches:
                  # Assuming first table is for 'í•™ìŠµí•˜ê¸°', second is for 'ì‹¤ì „ í›ˆë ¨'
                  table = match.strip()
                  # Place the first table under 'í•™ìŠµí•˜ê¸°' and second under 'ì‹¤ì „ í›ˆë ¨'
                  if len(tables["í•™ìŠµí•˜ê¸°"]) == 0:
                      tables["í•™ìŠµí•˜ê¸°"].append(table)
                  else:
                      tables["ì‹¤ì „ í›ˆë ¨"].append(table)

              return tables

          def merge_tables(base_dir, output_file):
              """
              Merges tables from multiple README files into one consolidated README.
              """
              combined_tables = {
                  "í•™ìŠµí•˜ê¸°": [],
                  "ì‹¤ì „ í›ˆë ¨": []
              }

              for root, _, files in os.walk(base_dir):
                  for file in files:
                      if file.lower() == "readme.md":
                          filepath = os.path.join(root, file)
                          with open(filepath, "r", encoding="utf-8") as infile:
                              content = infile.read()
                              tables = extract_tables(content)

                              # Merge tables into respective categories
                              if tables["í•™ìŠµí•˜ê¸°"]:
                                  combined_tables["í•™ìŠµí•˜ê¸°"].extend(tables["í•™ìŠµí•˜ê¸°"])
                              if tables["ì‹¤ì „ í›ˆë ¨"]:
                                  combined_tables["ì‹¤ì „ í›ˆë ¨"].extend(tables["ì‹¤ì „ í›ˆë ¨"])

              # Write the merged tables to the output README
              with open(output_file, "w", encoding="utf-8") as outfile:
                  outfile.write("# Combined README\n\n")
                  
                  # Write 'í•™ìŠµí•˜ê¸°' table
                  outfile.write("## ğŸ“– í•™ìŠµí•˜ê¸°\n\n")
                  for table in combined_tables["í•™ìŠµí•˜ê¸°"]:
                      outfile.write(table + "\n\n")

                  # Write 'ì‹¤ì „ í›ˆë ¨' table
                  outfile.write("## ğŸ¥‡ ì‹¤ì „ í›ˆë ¨\n\n")
                  for table in combined_tables["ì‹¤ì „ í›ˆë ¨"]:
                      outfile.write(table + "\n\n")

          merge_tables(".", "Combined_README.md")
          EOF

      # 4. ë³€ê²½ëœ íŒŒì¼ ì»¤ë°‹ ë° í‘¸ì‹œ
      - name: Commit changes
        run: |
          git config user.name "ddings73"
          git config user.email "ddings7303@gmail.com"
          git add README.md
          git commit -m "README ë³‘í•©"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.MY_SECRET_TOKEN }}
